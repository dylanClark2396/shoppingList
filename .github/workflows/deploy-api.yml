name: Deploy Express Backend (SSM + OIDC)

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install and build backend
        working-directory: backend
        run: |
          pnpm install
          pnpm run build

      - name: Create deployment archive
        working-directory: backend
        run: zip -r ../api-release.zip package.json dist/

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE }}
          aws-region: us-east-2

      - name: Upload artifact to S3
        run: |
          aws s3 cp api-release.zip s3://${{ secrets.DEPLOY_BUCKET }}/api-release.zip

      - name: Deploy via SSM
        run: |
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /home/ec2-user/apps",
              "aws s3 cp s3://${{ secrets.DEPLOY_BUCKET }}/api-release.zip .",
              "rm -rf api",
              "mkdir api",
              "unzip api-release.zip -d api",
              "cd api",
              "npm install --omit=dev",
              "pm2 restart api || pm2 start dist/server.js --name api"
            ]'