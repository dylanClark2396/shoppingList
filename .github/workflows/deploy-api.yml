name: Deploy Express Backend (SSM + OIDC)

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-api.yml'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install and build backend
        working-directory: backend
        run: |
          pnpm install
          pnpm run build

      - name: Create deployment archive
        working-directory: backend
        run: zip -r ../api-release.zip package.json dist/

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE }}
          aws-region: us-east-2

      - name: Upload artifact to S3
        run: |
          aws s3 cp api-release.zip s3://${{ secrets.DEPLOY_BUCKET }}/api-release.zip

      - name: Deploy via SSM
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --query "Command.CommandId" \
            --output text \
            --parameters 'commands=[
              "export NVM_DIR=\"$HOME/.nvm\"",
              "[ -s \"$NVM_DIR/nvm.sh\" ] && . \"$NVM_DIR/nvm.sh\"",
              "source ~/.bashrc",

              "cd /home/ec2-user/apps",
              "chown -R ec2-user:ec2-user /home/ec2-user/apps",

              "rm -rf api/*",

              "aws s3 cp s3://${{ secrets.DEPLOY_BUCKET }}/api-release.zip /home/ec2-user/apps/api-release.zip",
              "chown ec2-user:ec2-user /home/ec2-user/apps/api-release.zip",

              "unzip -o /home/ec2-user/apps/api-release.zip -d api",

              "cd /home/ec2-user/apps/api",

              "pnpm install --prod",

              "pm2 stop api || true",
              "pm2 start dist/server.js --name api"
            ]')

          echo "Command ID: $COMMAND_ID"

          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}"

          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}"